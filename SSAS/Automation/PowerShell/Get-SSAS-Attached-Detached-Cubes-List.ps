$ssasInstances = @("SSAS02\\TABULAR")

[System.Reflection.Assembly]::LoadWithPartialName("Microsoft.AnalysisServices") | Out-Null
[System.Reflection.Assembly]::LoadWithPartialName("Microsoft.AnalysisServices.Tabular") | Out-Null

$results = @()

foreach ($instance in $ssasInstances) {
    try {
        $server = New-Object Microsoft.AnalysisServices.Server
        $server.Connect($instance)

        $serverName = ($instance -split "\\")[0]
        $dataDir = $server.ServerProperties["DataDir"].Value
        $uncPath = "\\$serverName\" + ($dataDir -replace ":", "$")

        # Get attached model names
        $attached = @{}
        foreach ($db in $server.Databases) {
            if ($db.Model) {
                $attached[$db.Name] = $true
            }
        }

        # Scan cube folders
        $dirs = Get-ChildItem -Path $uncPath -Directory -ErrorAction SilentlyContinue
        foreach ($dir in $dirs) {
            if ($dir.Name -match "\.0\.db$") {
                $cubeName = $dir.Name -replace "\.0\.db$", ""
                $status = if ($attached.ContainsKey($cubeName)) { "Attached" } else { "Detached" }

                $results += "$instance|$cubeName|$status"
            }
        }

        $server.Disconnect()
    }
    catch {
        Write-Warning "$instance failed: $_"
    }
}

$results | Out-File "SSAS_Cube_Status.txt"
Write-Host "Audit complete. Saved to SSAS_Cube_Status.txt"
